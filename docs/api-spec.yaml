openapi: 3.0.3
info:
  title: ZRP API
  description: |
    ZRP (Zero-Revision Parts) is a comprehensive Manufacturing Execution System (MES) and Product Lifecycle Management (PLM) platform.
    
    This API provides programmatic access to all ZRP functionality including parts management, inventory control, work orders, 
    ECOs, quality management, and more.
    
    ## Authentication
    
    ZRP supports two authentication methods:
    
    ### 1. Session Cookie Authentication (For Web UI)
    - Obtain a session by POSTing credentials to `/auth/login`
    - Session cookie `zrp_session` is automatically included in subsequent requests
    - Sessions expire after 24 hours of inactivity (sliding window)
    
    ### 2. API Key Authentication (For Programmatic Access)
    - Generate an API key via the UI or `/api/v1/apikeys` endpoint
    - Include in requests as: `Authorization: Bearer zrp_XXXXX`
    - API keys can have expiration dates and can be disabled
    
    ## Response Format
    
    All successful API responses are wrapped in an envelope:
    ```json
    {
      "data": { ... }
    }
    ```
    
    Paginated responses include metadata:
    ```json
    {
      "data": [...],
      "meta": {
        "total": 150,
        "page": 1,
        "limit": 50
      }
    }
    ```
    
    Error responses:
    ```json
    {
      "error": "Error message",
      "code": "ERROR_CODE"
    }
    ```
    
  version: 1.0.0
  contact:
    name: ZRP Support
  license:
    name: MIT

servers:
  - url: http://localhost:9000
    description: Development server
  - url: /
    description: Current server

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Parts
    description: Part catalog and BOM management
  - name: Inventory
    description: Inventory tracking and transactions
  - name: Work Orders
    description: Manufacturing work orders
  - name: Purchase Orders
    description: Procurement and receiving
  - name: ECOs
    description: Engineering Change Orders
  - name: Documents
    description: Document management and version control
  - name: Quality
    description: NCRs, CAPAs, and testing
  - name: Devices
    description: Device tracking and firmware management
  - name: Sales
    description: Quotes, sales orders, and invoicing
  - name: Admin
    description: System administration
  - name: Reports
    description: Analytics and reporting

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API Key
      description: API key authentication using Bearer token (format zrp_XXXXX)
    cookieAuth:
      type: apiKey
      in: cookie
      name: zrp_session
      description: Session cookie obtained from /auth/login

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
      required:
        - error

    Meta:
      type: object
      properties:
        total:
          type: integer
          description: Total number of records
        page:
          type: integer
          description: Current page number
        limit:
          type: integer
          description: Records per page

    User:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        display_name:
          type: string
        role:
          type: string
          enum: [admin, manager, engineer, operator, viewer]
        active:
          type: integer
          description: 1 if active, 0 if deactivated
        created_at:
          type: string
          format: date-time
        last_login:
          type: string
          format: date-time

    Part:
      type: object
      properties:
        ipn:
          type: string
          description: Internal Part Number (unique identifier)
        category:
          type: string
          description: Part category name
        category_id:
          type: integer
        lifecycle_stage:
          type: string
          enum: [design, prototype, production, obsolete]
        fields:
          type: object
          description: Dynamic fields specific to the category
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          type: string

    BOMItem:
      type: object
      properties:
        child_ipn:
          type: string
        quantity:
          type: number
        reference:
          type: string
        notes:
          type: string

    InventoryItem:
      type: object
      properties:
        id:
          type: integer
        ipn:
          type: string
        location:
          type: string
        quantity:
          type: number
        lot_number:
          type: string
        serial_number:
          type: string
        received_date:
          type: string
          format: date
        expiry_date:
          type: string
          format: date
        unit_cost:
          type: number

    WorkOrder:
      type: object
      properties:
        id:
          type: integer
        wo_number:
          type: string
        ipn:
          type: string
        quantity:
          type: integer
        status:
          type: string
          enum: [planned, released, in-progress, completed, cancelled]
        priority:
          type: string
          enum: [low, normal, high, urgent]
        due_date:
          type: string
          format: date
        start_date:
          type: string
          format: date
        completion_date:
          type: string
          format: date
        assigned_to:
          type: string
        notes:
          type: string

    PurchaseOrder:
      type: object
      properties:
        id:
          type: integer
        po_number:
          type: string
        vendor_id:
          type: integer
        vendor_name:
          type: string
        status:
          type: string
          enum: [draft, sent, acknowledged, received, closed]
        order_date:
          type: string
          format: date
        expected_date:
          type: string
          format: date
        lines:
          type: array
          items:
            type: object
            properties:
              ipn:
                type: string
              quantity:
                type: number
              unit_price:
                type: number
              received:
                type: number

    ECO:
      type: object
      properties:
        id:
          type: integer
        eco_number:
          type: string
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [draft, submitted, approved, implemented, rejected]
        priority:
          type: string
          enum: [low, medium, high, critical]
        category:
          type: string
          enum: [design, process, documentation, other]
        requested_by:
          type: string
        approved_by:
          type: string
        approval_date:
          type: string
          format: date-time
        implementation_date:
          type: string
          format: date-time
        affected_parts:
          type: array
          items:
            type: string

    NCR:
      type: object
      properties:
        id:
          type: integer
        ncr_number:
          type: string
        title:
          type: string
        description:
          type: string
        severity:
          type: string
          enum: [critical, major, minor]
        status:
          type: string
          enum: [open, investigating, resolved, closed]
        affected_ipn:
          type: string
        lot_number:
          type: string
        quantity_affected:
          type: integer
        root_cause:
          type: string
        corrective_action:
          type: string
        reported_by:
          type: string
        reported_date:
          type: string
          format: date-time

    CAPA:
      type: object
      properties:
        id:
          type: integer
        capa_number:
          type: string
        title:
          type: string
        description:
          type: string
        type:
          type: string
          enum: [corrective, preventive]
        status:
          type: string
          enum: [open, in-progress, completed, verified, closed]
        priority:
          type: string
          enum: [low, medium, high, critical]
        source_ncr_id:
          type: integer
        assigned_to:
          type: string
        due_date:
          type: string
          format: date

    APIKey:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        key_prefix:
          type: string
          description: First 12 characters of the key (for identification)
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        last_used:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        enabled:
          type: integer
          description: 1 if enabled, 0 if disabled

paths:
  # ==================== AUTHENTICATION ====================
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate with username/password and receive a session cookie
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              schema:
                type: string
                example: zrp_session=abc123; Path=/; HttpOnly; SameSite=Lax
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded (max 5 attempts per minute per IP)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      description: Invalidate current session
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Retrieve information about the currently authenticated user
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/change-password:
    post:
      tags:
        - Authentication
      summary: Change password
      description: Change password for the current user
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - current_password
                - new_password
              properties:
                current_password:
                  type: string
                new_password:
                  type: string
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        '400':
          description: Invalid request
        '401':
          description: Current password incorrect

  # ==================== API KEYS ====================
  /api/v1/apikeys:
    get:
      tags:
        - Admin
      summary: List API keys
      description: Get all API keys (admin only)
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/APIKey'
        '403':
          description: Forbidden - admin only

    post:
      tags:
        - Admin
      summary: Create API key
      description: Generate a new API key (admin only)
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  description: Descriptive name for the API key
                expires_at:
                  type: string
                  format: date-time
                  description: Optional expiration date
      responses:
        '201':
          description: API key created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
                  key:
                    type: string
                    description: Full API key - shown only once
                  key_prefix:
                    type: string
                  created_at:
                    type: string
                  enabled:
                    type: integer
                  message:
                    type: string
                    example: Store this key securely. It will not be shown again.
        '400':
          description: Invalid request
        '403':
          description: Forbidden - admin only

  /api/v1/apikeys/{id}:
    put:
      tags:
        - Admin
      summary: Enable/disable API key
      description: Toggle an API key's enabled status
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - enabled
              properties:
                enabled:
                  type: integer
                  enum: [0, 1]
      responses:
        '200':
          description: API key updated
        '404':
          description: API key not found

    delete:
      tags:
        - Admin
      summary: Delete API key
      description: Revoke and delete an API key
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: API key deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: revoked
        '404':
          description: API key not found

  # ==================== PARTS ====================
  /api/v1/parts:
    get:
      tags:
        - Parts
      summary: List parts
      description: Get paginated list of parts with optional filtering
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: category
          in: query
          schema:
            type: string
          description: Filter by category name
        - name: q
          in: query
          schema:
            type: string
          description: Search query (searches IPN and fields)
        - name: lifecycle_stage
          in: query
          schema:
            type: string
            enum: [design, prototype, production, obsolete]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of parts
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Part'
                  meta:
                    $ref: '#/components/schemas/Meta'

    post:
      tags:
        - Parts
      summary: Create part
      description: Create a new part
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ipn
                - category
              properties:
                ipn:
                  type: string
                  description: Internal Part Number (must be unique)
                category:
                  type: string
                  description: Category name or ID
                lifecycle_stage:
                  type: string
                  enum: [design, prototype, production, obsolete]
                  default: design
                fields:
                  type: object
                  description: Category-specific fields
                  additionalProperties: true
                bom:
                  type: array
                  description: Bill of Materials
                  items:
                    $ref: '#/components/schemas/BOMItem'
      responses:
        '201':
          description: Part created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Part'
        '400':
          description: Invalid request or IPN already exists
        '403':
          description: Forbidden - insufficient permissions

  /api/v1/parts/{ipn}:
    get:
      tags:
        - Parts
      summary: Get part
      description: Retrieve a specific part by IPN
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: ipn
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Part details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Part'
        '404':
          description: Part not found

    put:
      tags:
        - Parts
      summary: Update part
      description: Update an existing part
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: ipn
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                lifecycle_stage:
                  type: string
                fields:
                  type: object
                  additionalProperties: true
                bom:
                  type: array
                  items:
                    $ref: '#/components/schemas/BOMItem'
      responses:
        '200':
          description: Part updated
        '400':
          description: Invalid request
        '404':
          description: Part not found

    delete:
      tags:
        - Parts
      summary: Delete part
      description: Delete a part (soft delete - marks as obsolete)
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: ipn
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Part deleted
        '404':
          description: Part not found

  /api/v1/parts/{ipn}/bom:
    get:
      tags:
        - Parts
      summary: Get part BOM
      description: Retrieve the Bill of Materials for a part
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: ipn
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: BOM tree
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/BOMItem'

  /api/v1/parts/{ipn}/cost:
    get:
      tags:
        - Parts
      summary: Get part cost
      description: Calculate total cost including BOM
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: ipn
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Cost breakdown
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      total_cost:
                        type: number
                      material_cost:
                        type: number
                      bom_cost:
                        type: number

  /api/v1/parts/{ipn}/where-used:
    get:
      tags:
        - Parts
      summary: Where-used analysis
      description: Find all parts that use this part in their BOM
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: ipn
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of parent parts
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        parent_ipn:
                          type: string
                        quantity:
                          type: number

  # ==================== INVENTORY ====================
  /api/v1/inventory:
    get:
      tags:
        - Inventory
      summary: List inventory
      description: Get paginated list of inventory items
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: ipn
          in: query
          schema:
            type: string
        - name: location
          in: query
          schema:
            type: string
        - name: low_stock
          in: query
          schema:
            type: boolean
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of inventory items
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/InventoryItem'
                  meta:
                    $ref: '#/components/schemas/Meta'

  /api/v1/inventory/transact:
    post:
      tags:
        - Inventory
      summary: Inventory transaction
      description: Add or remove inventory (stock in/out)
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ipn
                - location
                - quantity
                - transaction_type
              properties:
                ipn:
                  type: string
                location:
                  type: string
                quantity:
                  type: number
                transaction_type:
                  type: string
                  enum: [in, out, adjust, transfer]
                lot_number:
                  type: string
                serial_number:
                  type: string
                unit_cost:
                  type: number
                notes:
                  type: string
      responses:
        '200':
          description: Transaction completed
        '400':
          description: Invalid request or insufficient stock

  /api/v1/inventory/{id}/history:
    get:
      tags:
        - Inventory
      summary: Inventory history
      description: Get transaction history for an inventory item
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Transaction history
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        transaction_type:
                          type: string
                        quantity:
                          type: number
                        timestamp:
                          type: string
                        user:
                          type: string
                        notes:
                          type: string

  # ==================== WORK ORDERS ====================
  /api/v1/workorders:
    get:
      tags:
        - Work Orders
      summary: List work orders
      description: Get paginated list of work orders
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [planned, released, in-progress, completed, cancelled]
        - name: ipn
          in: query
          schema:
            type: string
        - name: assigned_to
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of work orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkOrder'
                  meta:
                    $ref: '#/components/schemas/Meta'

    post:
      tags:
        - Work Orders
      summary: Create work order
      description: Create a new work order
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ipn
                - quantity
              properties:
                ipn:
                  type: string
                quantity:
                  type: integer
                  minimum: 1
                status:
                  type: string
                  default: planned
                priority:
                  type: string
                  default: normal
                due_date:
                  type: string
                  format: date
                assigned_to:
                  type: string
                notes:
                  type: string
      responses:
        '201':
          description: Work order created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/WorkOrder'

  /api/v1/workorders/{id}:
    get:
      tags:
        - Work Orders
      summary: Get work order
      description: Retrieve a specific work order
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Work order details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/WorkOrder'

    put:
      tags:
        - Work Orders
      summary: Update work order
      description: Update work order status and details
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                priority:
                  type: string
                assigned_to:
                  type: string
                notes:
                  type: string
      responses:
        '200':
          description: Work order updated

  # ==================== PURCHASE ORDERS ====================
  /api/v1/pos:
    get:
      tags:
        - Purchase Orders
      summary: List purchase orders
      description: Get paginated list of POs
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
        - name: vendor_id
          in: query
          schema:
            type: integer
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of purchase orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PurchaseOrder'
                  meta:
                    $ref: '#/components/schemas/Meta'

    post:
      tags:
        - Purchase Orders
      summary: Create purchase order
      description: Create a new PO
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - vendor_id
                - lines
              properties:
                vendor_id:
                  type: integer
                expected_date:
                  type: string
                  format: date
                notes:
                  type: string
                lines:
                  type: array
                  items:
                    type: object
                    required:
                      - ipn
                      - quantity
                      - unit_price
                    properties:
                      ipn:
                        type: string
                      quantity:
                        type: number
                      unit_price:
                        type: number
      responses:
        '201':
          description: Purchase order created

  /api/v1/pos/{id}/receive:
    post:
      tags:
        - Purchase Orders
      summary: Receive purchase order
      description: Record receipt of PO items
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - lines
              properties:
                location:
                  type: string
                lines:
                  type: array
                  items:
                    type: object
                    properties:
                      ipn:
                        type: string
                      quantity_received:
                        type: number
                      lot_number:
                        type: string
      responses:
        '200':
          description: Items received

  # ==================== ECOs ====================
  /api/v1/ecos:
    get:
      tags:
        - ECOs
      summary: List ECOs
      description: Get paginated list of Engineering Change Orders
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
        - name: priority
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of ECOs
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ECO'
                  meta:
                    $ref: '#/components/schemas/Meta'

    post:
      tags:
        - ECOs
      summary: Create ECO
      description: Create a new Engineering Change Order
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - description
              properties:
                title:
                  type: string
                description:
                  type: string
                priority:
                  type: string
                  default: medium
                category:
                  type: string
                  default: design
                affected_parts:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: ECO created

  /api/v1/ecos/{id}/approve:
    post:
      tags:
        - ECOs
      summary: Approve ECO
      description: Approve an ECO (requires manager/admin role)
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: ECO approved
        '403':
          description: Insufficient permissions

  /api/v1/ecos/{id}/implement:
    post:
      tags:
        - ECOs
      summary: Implement ECO
      description: Mark ECO as implemented and apply changes
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: ECO implemented
        '400':
          description: ECO not approved or invalid state

  # ==================== QUALITY - NCRs ====================
  /api/v1/ncrs:
    get:
      tags:
        - Quality
      summary: List NCRs
      description: Get paginated list of Non-Conformance Reports
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
        - name: severity
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of NCRs
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/NCR'
                  meta:
                    $ref: '#/components/schemas/Meta'

    post:
      tags:
        - Quality
      summary: Create NCR
      description: Create a new Non-Conformance Report
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - description
                - severity
              properties:
                title:
                  type: string
                description:
                  type: string
                severity:
                  type: string
                  enum: [critical, major, minor]
                affected_ipn:
                  type: string
                lot_number:
                  type: string
                quantity_affected:
                  type: integer
      responses:
        '201':
          description: NCR created

  /api/v1/ncrs/{id}/create-capa:
    post:
      tags:
        - Quality
      summary: Create CAPA from NCR
      description: Generate a CAPA from an NCR
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - type
              properties:
                title:
                  type: string
                type:
                  type: string
                  enum: [corrective, preventive]
                assigned_to:
                  type: string
      responses:
        '201':
          description: CAPA created from NCR

  # ==================== QUALITY - CAPAs ====================
  /api/v1/capas:
    get:
      tags:
        - Quality
      summary: List CAPAs
      description: Get paginated list of Corrective and Preventive Actions
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
        - name: type
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of CAPAs
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CAPA'
                  meta:
                    $ref: '#/components/schemas/Meta'

    post:
      tags:
        - Quality
      summary: Create CAPA
      description: Create a new CAPA
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - type
              properties:
                title:
                  type: string
                description:
                  type: string
                type:
                  type: string
                  enum: [corrective, preventive]
                priority:
                  type: string
                assigned_to:
                  type: string
                due_date:
                  type: string
                  format: date
      responses:
        '201':
          description: CAPA created

  # ==================== SEARCH ====================
  /api/v1/search:
    get:
      tags:
        - Parts
      summary: Global search
      description: Search across parts, documents, ECOs, and other entities
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      parts:
                        type: array
                      docs:
                        type: array
                      ecos:
                        type: array
                      workorders:
                        type: array

  # ==================== DASHBOARD ====================
  /api/v1/dashboard:
    get:
      tags:
        - Reports
      summary: Dashboard statistics
      description: Get high-level dashboard metrics
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Dashboard data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      total_parts:
                        type: integer
                      low_stock_alerts:
                        type: integer
                      active_work_orders:
                        type: integer
                      pending_ecos:
                        type: integer
                      total_inventory_value:
                        type: number

security:
  - bearerAuth: []
  - cookieAuth: []
