{{define "content"}}
<div class="mb-4">
  <a href="/ncrs" class="text-blue-600 hover:underline text-sm">&larr; Back to NCRs</a>
</div>

<div class="card">
  <h2 class="text-xl font-bold mb-4">{{if .NCR.ID}}Edit NCR: {{.NCR.ID}}{{else}}New NCR{{end}}</h2>
  
  <form id="ncr-form" hx-post="{{if .NCR.ID}}/api/v1/ncrs/{{.NCR.ID}}{{else}}/api/v1/ncrs{{end}}" 
        hx-swap="none" hx-on::after-request="handleNCRResponse(event)">
    {{if .NCR.ID}}<input type="hidden" name="_method" value="PUT">{{end}}
    
    <div class="space-y-4">
      <div>
        <label class="label" for="title">Title <span class="text-red-500">*</span></label>
        <input type="text" id="title" name="title" class="input" value="{{.NCR.Title}}" required>
      </div>

      <div>
        <label class="label" for="description">Description</label>
        <textarea id="description" name="description" class="input" rows="3">{{.NCR.Description}}</textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label" for="ipn">IPN</label>
          <input type="text" id="ipn" name="ipn" class="input" value="{{.NCR.IPN}}">
        </div>
        <div>
          <label class="label" for="serial_number">Serial Number</label>
          <input type="text" id="serial_number" name="serial_number" class="input" value="{{.NCR.SerialNumber}}">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="label" for="defect_type">Defect Type</label>
          <select id="defect_type" name="defect_type" class="input">
            <option value="">Select...</option>
            <option value="workmanship" {{if eq .NCR.DefectType "workmanship"}}selected{{end}}>Workmanship</option>
            <option value="design" {{if eq .NCR.DefectType "design"}}selected{{end}}>Design</option>
            <option value="component" {{if eq .NCR.DefectType "component"}}selected{{end}}>Component</option>
            <option value="process" {{if eq .NCR.DefectType "process"}}selected{{end}}>Process</option>
            <option value="other" {{if eq .NCR.DefectType "other"}}selected{{end}}>Other</option>
          </select>
        </div>
        <div>
          <label class="label" for="severity">Severity</label>
          <select id="severity" name="severity" class="input">
            <option value="minor" {{if eq .NCR.Severity "minor"}}selected{{end}}>Minor</option>
            <option value="major" {{if eq .NCR.Severity "major"}}selected{{end}}>Major</option>
            <option value="critical" {{if eq .NCR.Severity "critical"}}selected{{end}}>Critical</option>
          </select>
        </div>
        <div>
          <label class="label" for="status">Status</label>
          <select id="status" name="status" class="input" onchange="updateECOCheckbox()">
            <option value="open" {{if eq .NCR.Status "open"}}selected{{end}}>Open</option>
            <option value="investigating" {{if eq .NCR.Status "investigating"}}selected{{end}}>Investigating</option>
            <option value="resolved" {{if eq .NCR.Status "resolved"}}selected{{end}}>Resolved</option>
            <option value="closed" {{if eq .NCR.Status "closed"}}selected{{end}}>Closed</option>
          </select>
        </div>
      </div>

      <div>
        <label class="label" for="root_cause">Root Cause</label>
        <textarea id="root_cause" name="root_cause" class="input" rows="3">{{.NCR.RootCause}}</textarea>
      </div>

      <div>
        <label class="label" for="corrective_action">Corrective Action</label>
        <textarea id="corrective_action" name="corrective_action" class="input" rows="3" onchange="updateECOCheckbox()">{{.NCR.CorrectiveAction}}</textarea>
      </div>

      <div id="eco-checkbox" class="hidden">
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" name="create_eco" id="create_eco" checked> 
          Create linked ECO for corrective action
        </label>
      </div>

      <div class="flex gap-2 pt-4">
        <button type="submit" class="btn btn-primary">
          {{if .NCR.ID}}Update{{else}}Create{{end}} NCR
        </button>
        <a href="/ncrs" class="btn btn-secondary">Cancel</a>
      </div>
    </div>
  </form>
</div>

<script>
function updateECOCheckbox() {
  const status = document.getElementById('status').value;
  const action = document.getElementById('corrective_action').value.trim();
  const checkbox = document.getElementById('eco-checkbox');
  
  if ((status === 'resolved' || status === 'closed') && action) {
    checkbox.classList.remove('hidden');
  } else {
    checkbox.classList.add('hidden');
  }
}

function handleNCRResponse(event) {
  if (event.detail.xhr.status >= 200 && event.detail.xhr.status < 300) {
    const response = JSON.parse(event.detail.xhr.response);
    if (response.data && response.data.linked_eco_id) {
      showToast(`NCR saved. ECO ${response.data.linked_eco_id} created for corrective action.`, 'success');
    } else {
      showToast('NCR saved successfully', 'success');
    }
    setTimeout(() => window.location.href = '/ncrs', 1000);
  } else {
    showToast('Error saving NCR', 'error');
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', updateECOCheckbox);
</script>
{{end}}