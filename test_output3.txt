--- FAIL: TestAPIHealth (0.10s)
    --- FAIL: TestAPIHealth/Login (0.00s)
        api_health_test.go:261: Login returned unexpected 404. Body: 404 page not found
        api_health_test.go:266: Login: expected status 200, got 404. Body: 404 page not found
    --- FAIL: TestAPIHealth/Me (0.00s)
        api_health_test.go:266: Me: expected status 200, got 401. Body: {"code":"UNAUTHORIZED","error":"Unauthorized"}
    --- FAIL: TestAPIHealth/Part_BOM (0.00s)
        api_health_test.go:266: Part BOM: expected status 200, got 400. Body: {"error":"BOM only available for assembly IPNs (PCA, ASY prefix)"}
    --- FAIL: TestAPIHealth/List_Users (0.00s)
        api_health_test.go:266: List Users: expected status 200, got 401. Body: {"error":"Unauthorized"}
    --- FAIL: TestAPIHealth/List_Permissions (0.00s)
        api_health_test.go:256: List Permissions returned 500 Internal Server Error. Body: {"error":"SQL logic error: no such table: role_permissions (1)"}
        api_health_test.go:266: List Permissions: expected status 200, got 500. Body: {"error":"SQL logic error: no such table: role_permissions (1)"}
2026/02/19 14:46:12 Removed old backup: zrp-backup-2025-01-01T00-00-00.db
2026/02/19 14:46:12 Removed old backup: zrp-backup-2025-01-02T00-00-00.db
--- FAIL: TestBulkUpdateWorkOrdersStatus (0.32s)
    handler_bulk_update_test.go:125: expected 2 success, got 0
    handler_bulk_update_test.go:131: expected completed, got in_progress
--- FAIL: TestBulkUpdateWorkOrdersPriority (0.32s)
    handler_bulk_update_test.go:152: expected urgent, got high
--- FAIL: TestUndoChangeUpdate (0.32s)
    handler_changes_test.go:143: undo failed: 500 {"error":"undo failed: constraint failed: FOREIGN KEY constraint failed (1811)"}
--- FAIL: TestUndoChangeDelete (0.32s)
    handler_changes_test.go:164: delete failed: 409 {"error":"cannot delete vendor: 1 purchase orders reference it"}
--- FAIL: TestHandleImplementECO_Success (0.00s)
    handler_eco_test.go:555: Expected status 'implemented', got 
    handler_eco_test.go:562: Expected revision status 'implemented', got 
--- FAIL: TestRFQCloseWorkflow (0.32s)
    handler_rfq_test.go:358: expected closed status, got sent
--- FAIL: TestUndoDeleteVendor (0.32s)
    handler_undo_test.go:28: delete failed: 409 {"error":"cannot delete vendor: 1 purchase orders reference it"}
--- FAIL: TestWorkOrderKit (0.00s)
    handler_workorders_test.go:113: handler returned wrong status code: got 400 want 200, body: {"error":"kitting failed for some items"}
    handler_workorders_test.go:122: Expected wo_id WO001, got <nil>
    handler_workorders_test.go:126: Expected status kitted, got <nil>
    handler_workorders_test.go:133: SQL logic error: no such table: inventory (1)
--- FAIL: TestWorkOrderSerials (0.00s)
    handler_workorders_test.go:182: Expected serial TEST001, got 
    handler_workorders_test.go:186: Expected wo_id WO002, got 
    handler_workorders_test.go:204: json: cannot unmarshal object into Go value of type []main.WOSerial
--- FAIL: TestIntegration_PO_Receipt_Updates_Inventory (0.00s)
    integration_bom_po_test.go:186: === Integration Test: PO Receipt → Inventory Update ===
    integration_bom_po_test.go:189: Step 1: Insert vendor into database
    integration_bom_po_test.go:200: Step 2: Create inventory records with low stock
    integration_bom_po_test.go:214:    Created inventory: RES-INT-001 with qty_on_hand=5
    integration_bom_po_test.go:214:    Created inventory: CAP-INT-001 with qty_on_hand=2
    integration_bom_po_test.go:218: Step 3: Create purchase order with shortage line items
    integration_bom_po_test.go:242:    Added PO line: RES-INT-001 qty=95
    integration_bom_po_test.go:242:    Added PO line: CAP-INT-001 qty=48
    integration_bom_po_test.go:246: Step 4: Record initial inventory levels
    integration_bom_po_test.go:261: Step 5: Mark PO as received
    integration_bom_po_test.go:274: Step 6: Verify if inventory was automatically updated
    integration_bom_po_test.go:285:    CAP-INT-001: qty_on_hand = 2 (initial=2, expected=50)
    integration_bom_po_test.go:291:    ✗ WORKFLOW GAP DETECTED: Inventory NOT updated
    integration_bom_po_test.go:292:       Expected 50, got 2 (unchanged)
    integration_bom_po_test.go:285:    RES-INT-001: qty_on_hand = 5 (initial=5, expected=100)
    integration_bom_po_test.go:291:    ✗ WORKFLOW GAP DETECTED: Inventory NOT updated
    integration_bom_po_test.go:292:       Expected 100, got 5 (unchanged)
    integration_bom_po_test.go:300: Step 7: Verify inventory transactions were created
    integration_bom_po_test.go:311:    ✗ NO inventory transactions created for PO receipt
    integration_bom_po_test.go:316: === Test Results ===
    integration_bom_po_test.go:318: ✗✗ CRITICAL WORKFLOW GAP CONFIRMED:
    integration_bom_po_test.go:319:    PO receiving does NOT automatically update inventory
    integration_bom_po_test.go:320:    This must be implemented for production use
    integration_bom_po_test.go:321: 
    integration_bom_po_test.go:322: Required implementation:
    integration_bom_po_test.go:323:    1. When PO is received, iterate through po_lines
    integration_bom_po_test.go:324:    2. For each line, UPDATE inventory SET qty_onhand = qty_onhand + line.qty
    integration_bom_po_test.go:325:    3. INSERT inventory_transactions record for audit trail
    integration_bom_po_test.go:330: === Integration Test Complete ===
--- FAIL: TestIntegration_WorkOrder_Completion_Updates_Inventory (0.00s)
    integration_bom_po_test.go:343: === Integration Test: WO Completion → Inventory Update ===
    integration_bom_po_test.go:346: Step 1: Create component and assembly inventory
    integration_bom_po_test.go:366:    Created: RES-WO-001 with qty_on_hand=200
    integration_bom_po_test.go:367:    Created: ASY-WO-001 with qty_on_hand=0
    integration_bom_po_test.go:370: Step 2: Create work order for 10x ASY-WO-001
    integration_bom_po_test.go:381: Step 3: Mark work order as completed
    integration_bom_po_test.go:388:    ✓ Work order status set to 'completed'
    integration_bom_po_test.go:391: Step 4: Verify finished goods added to inventory
    integration_bom_po_test.go:399:    ASY-WO-001: qty_on_hand = 0 (expected 10)
    integration_bom_po_test.go:405:    ✗ WORKFLOW GAP: Finished goods NOT added to inventory
    integration_bom_po_test.go:410: Step 5: Verify inventory transactions created
    integration_bom_po_test.go:421:    ✗ NO inventory transactions created
    integration_bom_po_test.go:426: === Test Results ===
    integration_bom_po_test.go:428: ✗✗ CRITICAL WORKFLOW GAP CONFIRMED:
    integration_bom_po_test.go:429:    Work order completion does NOT update inventory
    integration_bom_po_test.go:430: 
    integration_bom_po_test.go:431: Required implementation:
    integration_bom_po_test.go:432:    1. When WO status → 'completed', query WO qty and ipn
    integration_bom_po_test.go:433:    2. UPDATE inventory SET qty_onhand = qty_onhand + wo.qty WHERE ipn = wo.ipn
    integration_bom_po_test.go:434:    3. INSERT inventory_transactions for audit trail
    integration_bom_po_test.go:435:    4. (Optional) Deduct component materials from inventory
    integration_bom_po_test.go:440: === Integration Test Complete ===
--- FAIL: TestIntegration_Real_WorkOrder_Completion (0.00s)
    integration_real_test.go:340: Created work order: WO-2026-0001
    integration_real_test.go:347: Initial state: ASY-TEST-001 qty=0, COMP-001 qty=100 reserved=20
    integration_real_test.go:380: Failed to complete work order: {"error":"SQL logic error: no such table: work_orders (1)"}
--- FAIL: TestIntegration_ECO_Part_Update_BOM_Impact (0.10s)
    integration_workflow_test.go:56: ✓ Authenticated as admin
    integration_workflow_test.go:268: === TEST 2: ECO → Part Update → BOM Impact ===
    integration_workflow_test.go:271: 
        [1] Creating original parts...
    integration_workflow_test.go:301: ✓ Created parts: OLD-PART-1771541210142240000 (old), NEW-PART-1771541210142240000 (new), ASY-ECO-1771541210142240000 (assembly)
    integration_workflow_test.go:304: 
        [2] Creating BOM with old part...
    integration_workflow_test.go:312: ✓ Created BOM: ASY-ECO-1771541210142240000 uses 2x OLD-PART-1771541210142240000
    integration_workflow_test.go:315: 
        [3] Creating ECO for part change...
    integration_workflow_test.go:329: ECO creation response: {"error":"priority: must be one of: low, normal, high, critical"}
    integration_workflow_test.go:342: ✓ Created ECO: ECO-INT-1771541210147408000
    integration_workflow_test.go:345: 
        [4] Approving ECO...
    integration_workflow_test.go:357: ECO approval response: {"error":"not found"}
    integration_workflow_test.go:359: ✓ Approved ECO: ECO-INT-1771541210147408000
    integration_workflow_test.go:362: 
        [5] Updating BOM to use new part...
    integration_workflow_test.go:374: ✓ Updated BOM: ASY-ECO-1771541210142240000 now uses NEW-PART-1771541210142240000
    integration_workflow_test.go:377: 
        [6] Verifying BOM update...
    integration_workflow_test.go:408: ✗ FAILURE: New part not in BOM
    integration_workflow_test.go:412: 
        [7] Verifying ECO tracking...
    integration_workflow_test.go:426: ECO status: 
    integration_workflow_test.go:429: 
        === TEST 2 COMPLETE ===
        
--- FAIL: TestIntegration_NCR_RMA_ECO_Flow (0.09s)
    integration_workflow_test.go:56: ✓ Authenticated as admin
    integration_workflow_test.go:442: === TEST 3: NCR → RMA → ECO Flow ===
    integration_workflow_test.go:445: 
        [1] Creating defective part...
    integration_workflow_test.go:454: ✓ Created part: DEFECT-1771541210231252000
    integration_workflow_test.go:457: 
        [2] Creating NCR for defective part...
    integration_workflow_test.go:472: NCR creation response: {"error":"title: is required"}
    integration_workflow_test.go:485: ✓ Created NCR: NCR-INT-1771541210233634000
    integration_workflow_test.go:488: 
        [3] Creating RMA linked to NCR...
    integration_workflow_test.go:502: RMA creation response: {"error":"serial_number: is required; status: must be one of: open, received, diagnosing, repairing, resolved, closed, scrapped"}
    integration_workflow_test.go:515: ✓ Created RMA: RMA-INT-1771541210234934000 linked to NCR: NCR-INT-1771541210233634000
    integration_workflow_test.go:518: 
        [4] Closing NCR with corrective action (trigger ECO)...
    integration_workflow_test.go:536: NCR close response: {"error":"not found"}
    integration_workflow_test.go:538: ✓ Closed NCR with corrective action
    integration_workflow_test.go:541: 
        [5] Creating ECO as corrective action...
    integration_workflow_test.go:555: ECO creation response: {"error":"not found"}
    integration_workflow_test.go:557: ✓ Created ECO: ECO-NCR-1771541210235830000
    integration_workflow_test.go:560: 
        [6] Verifying ECO ↔ NCR linkage...
    integration_workflow_test.go:590: ✗ NCR does not reference ECO (got: '')
    integration_workflow_test.go:593: ✗ ECO does not reference NCR (got: '')
    integration_workflow_test.go:598: 
        [7] Verifying RMA linkage...
    integration_workflow_test.go:611: 
        === TEST 3 COMPLETE ===
        
--- FAIL: TestIntegration_WorkOrder_Inventory_Consumption (0.61s)
    integration_workflow_test.go:56: ✓ Authenticated as admin
    integration_workflow_test.go:624: === TEST 4: Work Order → Inventory Consumption ===
    integration_workflow_test.go:627: 
        [1] Creating parts...
    integration_workflow_test.go:646: ✓ Created COMP-WO-1771541210320753000 (qty=100) and ASY-WO-1771541210320753000 (qty=0)
    integration_workflow_test.go:649: 
        [2] Creating BOM...
    integration_workflow_test.go:657: ✓ BOM: ASY-WO-1771541210320753000 requires 5x COMP-WO-1771541210320753000
    integration_workflow_test.go:660: 
        [3] Recording initial inventory...
    integration_workflow_test.go:681:   Initial: COMP-WO-1771541210320753000 = 0, ASY-WO-1771541210320753000 = 0
    integration_workflow_test.go:684: 
        [4] Creating work order for 10 assemblies...
    integration_workflow_test.go:710: ✓ Created work order: WO-2026-0025
    integration_workflow_test.go:713: 
        [5] Starting work order...
    integration_workflow_test.go:726: ✓ Started work order
    integration_workflow_test.go:729: 
        [6] Completing work order...
    integration_workflow_test.go:742: ✓ Completed work order
    integration_workflow_test.go:748: 
        [7] Verifying component consumption...
    integration_workflow_test.go:760: ✗ Component consumption incorrect
    integration_workflow_test.go:761:    Expected: -50, Got: 0
    integration_workflow_test.go:765: 
        [8] Verifying finished goods addition...
    integration_workflow_test.go:774: ✓✓ SUCCESS: Finished goods added correctly!
    integration_workflow_test.go:775:    ASY-WO-1771541210320753000: 0 → 10 (added 10)
    integration_workflow_test.go:782: 
        [9] Verifying inventory transactions...
    integration_workflow_test.go:801: ⚠ No inventory transactions found (may be logged elsewhere)
    integration_workflow_test.go:804: 
        === TEST 4 COMPLETE ===
        
2026/02/19 14:46:52 GET /api/v1/parts 2.667µs
--- FAIL: TestQualityWorkflowIntegration (0.01s)
    --- FAIL: TestQualityWorkflowIntegration/NCR_Creation_with_created_by (0.00s)
        quality_workflow_test.go:86: Expected created_by to be 'test_qe', got ''
        quality_workflow_test.go:93: Failed to query created_by from database: sql: no rows in result set
        quality_workflow_test.go:96: Database created_by should be 'test_qe', got ''
    --- FAIL: TestQualityWorkflowIntegration/Create_CAPA_from_NCR_via_API (0.00s)
        quality_workflow_test.go:125: Expected status 200, got 500: {"error":"SQL logic error: no such table: capas (1)"}
    --- FAIL: TestQualityWorkflowIntegration/Create_ECO_from_NCR_via_API (0.00s)
        quality_workflow_test.go:153: Failed to create test NCR: SQL logic error: no such table: ncrs (1)
    --- FAIL: TestQualityWorkflowIntegration/CAPA_Approval_Security (0.00s)
        quality_workflow_test.go:196: Failed to create test CAPA: SQL logic error: no such table: capas (1)
    --- FAIL: TestQualityWorkflowIntegration/CAPA_Status_Auto-advancement (0.00s)
        quality_workflow_test.go:261: Failed to create test CAPA: SQL logic error: no such table: capas (1)
--- FAIL: TestListReceivingAll (0.24s)
    receiving_eco_test.go:48: Failed to create PO line: SQL logic error: table po_lines has no column named qty (1)
--- FAIL: TestListReceivingPending (0.24s)
    receiving_eco_test.go:69: Failed to create PO line: SQL logic error: table po_lines has no column named qty (1)
--- FAIL: TestListReceivingInspected (0.24s)
    receiving_eco_test.go:89: Failed to create PO line: SQL logic error: table po_lines has no column named qty (1)
--- FAIL: TestInspectPass (0.24s)
    receiving_eco_test.go:109: Failed to create PO line: SQL logic error: table po_lines has no column named qty (1)
--- FAIL: TestInspectFail (0.24s)
    receiving_eco_test.go:156: Failed to create PO line: SQL logic error: table po_lines has no column named qty (1)
--- FAIL: TestInspectHold (0.24s)
    receiving_eco_test.go:188: Failed to create PO line: SQL logic error: table po_lines has no column named qty (1)
--- FAIL: TestInspectExceedsReceived (0.24s)
    receiving_eco_test.go:222: Failed to create PO line: SQL logic error: table po_lines has no column named qty (1)
2026/02/19 14:47:03 ws: client connected (1 total)
2026/02/19 14:47:03 ws: client disconnected
2026/02/19 14:47:03 ws: client connected (1 total)
2026/02/19 14:47:03 ws: client disconnected
2026/02/19 14:47:04 ws: client connected (1 total)
2026/02/19 14:47:04 ws: client connected (2 total)
2026/02/19 14:47:04 ws: client disconnected
2026/02/19 14:47:04 ws: client disconnected
2026/02/19 14:47:04 ws: client connected (1 total)
2026/02/19 14:47:04 ws: client connected (2 total)
2026/02/19 14:47:04 ws: client disconnected
2026/02/19 14:47:04 ws: client disconnected
2026/02/19 14:47:04 ws: client connected (1 total)
2026/02/19 14:47:04 ws: client disconnected
2026/02/19 14:47:08 ws: client connected (1 total)
2026/02/19 14:47:08 ws: client disconnected
FAIL
FAIL	zrp	97.476s
FAIL
